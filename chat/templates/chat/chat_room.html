{% extends "base.html" %}

{% block title %}Chat Room - {{ chatroom.event.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="text-center">{{ chatroom.event.name }} - Chat Room</h1>

    <!-- Chat Messages Box -->
    <div class="card chat-container">
        <div class="card-header bg-primary text-white">
            Chat Messages
        </div>
        <div id="chat-box" class="card-body chat-box">
            <!-- {% for message in messages %}
                <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
                    <p><strong>{{ message.sender.username }}</strong></p>
                    {% if message.content %}
                        <p class="message-text">{{ message.content }}</p>
                    {% endif %}
                    {% if message.file %}
                        <p><a href="{{ message.file.url }}" download class="file-link">ðŸ“Ž Download File</a></p>
                    {% endif %}
                    <span class="message-timestamp">{{ message.timestamp|date:"H:i" }}</span>
                </div>
            {% endfor %} -->

            {% for message in messages %}
                <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
                    <p>
                        <strong>
                            <a href="{% url 'accounts:public_profile' username=message.sender.username %}" class="user-link">
                                {{ message.sender.username }}
                            </a>
                        </strong>
                    </p>
                    {% if message.content %}
                        <p class="message-text">{{ message.content }}</p>
                    {% endif %}
                    {% if message.file %}
                        <p><a href="{{ message.file.url }}" download class="file-link">ðŸ“Ž Download File</a></p>
                    {% endif %}
                    <span class="message-timestamp">{{ message.timestamp|date:"H:i" }}</span>
                </div>
            {% endfor %}

        </div>
    </div>

    <!-- Message Input Form -->
    <form id="chat-form" class="mt-3">
        {% csrf_token %}
        <div class="input-group">
            <input type="text" id="chat-message" class="form-control" placeholder="Type a message...">
            <input type="file" id="chat-file" class="form-control-file">
            <button type="submit" class="btn btn-primary">Send</button>
        </div>
    </form>

    <div id="online-users" class="mt-3 text-muted">
        Online Users: <span id="user-count">0</span>
    </div>
</div>

<!-- Custom Chat Styles -->
<style>
    .chat-container {
        border-radius: 10px;
        overflow: hidden;
    }

    .chat-box {
        height: 400px;
        overflow-y: auto;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
    }

    .message {
        max-width: 80%;
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 10px;
        display: inline-block;
        clear: both;
    }

    .sent {
        background: #d1e7ff;
        color: #000;
        float: right;
        text-align: right;
    }

    .received {
        background: #e9ecef;
        color: #000;
        float: left;
        text-align: left;
    }

    .message p {
        margin: 5px 0;
    }

    .message-timestamp {
        font-size: 12px;
        color: gray;
        display: block;
    }

    .file-link {
        font-weight: bold;
        color: #007bff;
        text-decoration: none;
    }

    .file-link:hover {
        text-decoration: underline;
    }

    .input-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-control-file {
        margin-left: 10px;
    }
</style>

<!-- Chat WebSocket & JavaScript -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const protocol = window.location.protocol === "https:" ? "wss" : "ws";
        const chatSocket = new WebSocket(protocol + "://" + window.location.hostname + ":8001/ws/chat/{{ chatroom.event.id }}/");

        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            console.log("Received WebSocket Message:", data);

            if (data.type === "chat_message") {
                appendMessage(data.sender, data.message, data.file_url, data.timestamp);
            }
        };

        function appendMessage(sender, message, fileUrl, timestamp) {
            let chatBox = document.getElementById("chat-box");
            let messageContainer = document.createElement("div");

            messageContainer.classList.add("message");
            messageContainer.classList.add(sender === "{{ request.user.username }}" ? "sent" : "received");

            messageContainer.innerHTML = `<p><strong>${sender}</strong></p>`;
            if (message) {
                messageContainer.innerHTML += `<p class="message-text">${message}</p>`;
            }
            if (fileUrl) {
                messageContainer.innerHTML += `<p><a href="${fileUrl}" download class="file-link">ðŸ“Ž Download File</a></p>`;
            }
            messageContainer.innerHTML += `<span class="message-timestamp">${timestamp}</span>`;

            chatBox.appendChild(messageContainer);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        chatSocket.onclose = function () {
            console.warn("WebSocket connection closed.");
        };

        document.getElementById("chat-form").addEventListener("submit", function (e) {
            e.preventDefault();
            const messageInput = document.getElementById("chat-message");
            const fileInput = document.getElementById("chat-file");
            const message = messageInput.value.trim();
            const file = fileInput.files[0];

            if (!message && !file) {
                alert("Please enter a message or select a file.");
                return;
            }

            const formData = new FormData();
            formData.append("content", message);
            if (file) {
                formData.append("file", file);
            }

            fetch("{% url 'chat:send_message' chatroom.event.id %}", {
                method: "POST",
                body: formData,
                headers: { "X-CSRFToken": "{{ csrf_token }}" },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    appendMessage(data.sender, data.content, data.file_url, data.timestamp);
                }
            });

            messageInput.value = "";
            fileInput.value = "";
        });
    });
</script>
{% endblock %}
